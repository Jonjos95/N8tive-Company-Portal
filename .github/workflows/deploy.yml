name: Deploy to Live Site (EC2 + AWS)

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Validate HTML files
        run: |
          echo "âœ… Validating HTML structure..."
          find . -name "*.html" -not -path "./.git/*" -exec echo "Found: {}" \;
      
      - name: Check for required files
        run: |
          echo "ðŸ“ Validating project structure..."
          
          # Core files
          REQUIRED=(
            "index.html"
            "products.html"
            "pricing.html"
            "login.html"
            "style.css"
            "script.js"
            "auth.js"
          )
          
          MISSING=0
          for file in "${REQUIRED[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing: $file"
              MISSING=$((MISSING + 1))
            else
              echo "âœ… Found: $file"
            fi
          done
          
          # Components
          if [ ! -d "components" ]; then
            echo "âŒ Missing: components/ directory"
            MISSING=$((MISSING + 1))
          else
            echo "âœ… Found: components/ directory"
            if [ ! -f "components/navbar.js" ]; then
              echo "âš ï¸  Warning: components/navbar.js not found"
            fi
            if [ ! -f "components/footer.js" ]; then
              echo "âš ï¸  Warning: components/footer.js not found"
            fi
          fi
          
          # Assets
          if [ ! -d "assets/images/tech-logos" ]; then
            echo "âš ï¸  Warning: assets/images/tech-logos/ directory not found"
          else
            echo "âœ… Found: assets/images/tech-logos/ directory"
          fi
          
          if [ $MISSING -gt 0 ]; then
            echo "âŒ $MISSING required file(s) missing!"
            exit 1
          fi
          
          echo "âœ… All required files present"
      
      - name: Deploy to Hugging Face Spaces
        run: |
          # Hugging Face Spaces auto-deploys from GitHub when connected
          # This workflow validates files are ready before deployment
          HF_USERNAME="${HF_USERNAME:-jjosephdev}"
          HF_SPACE="${HF_SPACE:-n8tive-nexus-portal}"
          
          echo "âœ… Push successful - Hugging Face will auto-deploy"
          echo "ðŸ”— Space URL: https://huggingface.co/spaces/$HF_USERNAME/$HF_SPACE"
          echo "â„¹ï¸  If Space is connected to this repo, it will update automatically"
      
      - name: Deployment Status
        run: |
          echo "âœ… All checks passed!"
          echo "ðŸ“¦ Your site is ready to be served"
          echo "ðŸŒ Hugging Face Spaces will automatically update"

  aws:
    name: Deploy to AWS (S3 + CloudFront)
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check AWS secrets present
        id: check
        run: |
          missing=0
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "âš ï¸  Missing secret: AWS_ACCESS_KEY_ID"; missing=$((missing+1));
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "âš ï¸  Missing secret: AWS_SECRET_ACCESS_KEY"; missing=$((missing+1));
          fi
          if [ -z "${{ secrets.S3_BUCKET_NAME }}" ]; then
            echo "âš ï¸  Missing secret: S3_BUCKET_NAME"; missing=$((missing+1));
          fi
          if [ -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            echo "âš ï¸  Missing secret: CLOUDFRONT_DISTRIBUTION_ID"; missing=$((missing+1));
          fi
          if [ $missing -gt 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if secrets missing
        if: steps.check.outputs.skip == 'true'
        run: |
          echo "â„¹ï¸  AWS secrets not fully configured. Skipping AWS deployment."
          exit 0

      - name: Configure AWS credentials
        if: steps.check.outputs.skip != 'true'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Sync static assets to S3 (long cache)
        if: steps.check.outputs.skip != 'true'
        run: |
          aws s3 sync . s3://${{ secrets.S3_BUCKET_NAME }} \
            --exclude ".git/*" \
            --exclude "node_modules/*" \
            --exclude ".github/*" \
            --exclude "*.md" \
            --exclude ".DS_Store" \
            --exclude "deploy.sh" \
            --cache-control "public, max-age=31536000" \
            --delete \
            --exclude "*.html" \
            --exclude "*.json" \
            --exclude "components/navbar.js"

      - name: Upload HTML and navbar.js (short cache)
        if: steps.check.outputs.skip != 'true'
        run: |
          aws s3 sync . s3://${{ secrets.S3_BUCKET_NAME }} \
            --exclude "*" \
            --include "*.html" \
            --include "components/navbar.js" \
            --cache-control "public, max-age=3600" \
            --delete

      - name: Invalidate CloudFront cache
        if: steps.check.outputs.skip != 'true'
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      - name: AWS Deployment Status
        if: steps.check.outputs.skip != 'true'
        run: |
          echo "âœ… Deployed to S3 bucket: ${{ secrets.S3_BUCKET_NAME }}"
          echo "ðŸ§Š CloudFront distribution invalidated: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
          echo "ðŸŒ Your AWS site will reflect changes within a few minutes"

  ec2:
    name: Deploy to EC2
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check EC2 secrets present
        id: check_ec2
        run: |
          missing=0
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "âš ï¸  Missing secret: EC2_HOST"; missing=$((missing+1));
          fi
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "âš ï¸  Missing secret: EC2_SSH_KEY"; missing=$((missing+1));
          fi
          if [ $missing -gt 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if secrets missing
        if: steps.check_ec2.outputs.skip == 'true'
        run: |
          echo "â„¹ï¸  EC2 secrets not fully configured. Skipping EC2 deployment."
          exit 0

      - name: Setup SSH key
        if: steps.check_ec2.outputs.skip != 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Prepare files for deployment
        if: steps.check_ec2.outputs.skip != 'true'
        run: |
          echo "ðŸ“¦ Preparing files for deployment..."
          FILES_TO_DEPLOY=(
            "index.html"
            "style.css"
            "script.js"
            "auth.js"
            "login.html"
            "pricing.html"
            "products.html"
            "team.html"
            "components/"
            "assets/"
            "analytics-demo.html"
            "automation-demo.html"
          )
          
          mkdir -p deploy_temp
          for item in "${FILES_TO_DEPLOY[@]}"; do
            if [ -e "$item" ]; then
              echo "  âœ“ Including $item"
              cp -r "$item" deploy_temp/
            fi
          done

      - name: Upload files to EC2
        if: steps.check_ec2.outputs.skip != 'true'
        run: |
          EC2_USER="${{ secrets.EC2_USER || 'ubuntu' }}"
          EC2_HOST="${{ secrets.EC2_HOST }}"
          DEPLOY_DIR="${{ secrets.EC2_DEPLOY_DIR || '/var/www/n8tive' }}"
          
          echo "ðŸ“¤ Uploading to EC2..."
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST \
            "sudo mkdir -p $DEPLOY_DIR && sudo chown -R \$USER:\$USER $DEPLOY_DIR"
          
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no -r deploy_temp/* \
            $EC2_USER@$EC2_HOST:$DEPLOY_DIR/

      - name: Configure Nginx
        if: steps.check_ec2.outputs.skip != 'true'
        run: |
          EC2_USER="${{ secrets.EC2_USER || 'ubuntu' }}"
          EC2_HOST="${{ secrets.EC2_HOST }}"
          DEPLOY_DIR="${{ secrets.EC2_DEPLOY_DIR || '/var/www/n8tive' }}"
          
          echo "ðŸ”§ Configuring Nginx..."
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << EOF
          sudo tee /etc/nginx/sites-available/n8tive > /dev/null << NGINX
          server {
              listen 80;
              server_name _;
              
              root $DEPLOY_DIR;
              index index.html;
              
              # Single Page App routing
              location / {
                  try_files \$uri \$uri/ /index.html;
              }
              
              # Static asset caching
              location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|webp|woff2?)$ {
                  expires 30d;
                  add_header Cache-Control "public, max-age=2592000";
                  try_files \$uri =404;
              }
              
              # Security headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
          }
          NGINX
          
          # Enable site
          sudo ln -sf /etc/nginx/sites-available/n8tive /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          
          # Test and reload
          sudo nginx -t && sudo systemctl reload nginx
          
          echo "âœ… Nginx configured successfully"
          EOF

      - name: Cleanup
        if: steps.check_ec2.outputs.skip != 'true'
        run: |
          rm -rf deploy_temp
          rm -f ~/.ssh/ec2_key

      - name: EC2 Deployment Status
        if: steps.check_ec2.outputs.skip != 'true'
        run: |
          echo "âœ… Deployed to EC2: ${{ secrets.EC2_HOST }}"
          echo "ðŸŒ Your EC2 site is now live and updated"

